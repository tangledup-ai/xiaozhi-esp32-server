# 第一阶段：使用 mamba 安装 Python 依赖与系统工具
FROM mambaorg/micromamba:1.5.8 AS builder
ARG MAMBA_DOCKERFILE_ACTIVATE=1

WORKDIR /app

# 复制依赖清单
COPY main/xiaozhi-server/requirements.txt .

# 创建名为 xiaozhi 的环境，并通过 mamba 安装 Python、ffmpeg 与 libopus
RUN micromamba install -y -n xiaozhi -c conda-forge \
        python=3.10 \
        ffmpeg \
        libopus && \
    micromamba clean --all --yes

# 在新环境内使用 mamba 安装 Python 依赖
RUN micromamba install -y -n xiaozhi -c conda-forge --file requirements.txt && \
    micromamba clean --all --yes

# 第二阶段：生产镜像
FROM mambaorg/micromamba:1.5.8
ARG MAMBA_DOCKERFILE_ACTIVATE=1

WORKDIR /opt/xiaozhi-esp32-server

# 复制完整的 Python 环境
COPY --from=builder /opt/conda/envs/xiaozhi /opt/conda/envs/xiaozhi

# 配置 PATH，使容器默认使用已安装的环境
ENV PATH="/opt/conda/envs/xiaozhi/bin:${PATH}"

# 复制应用代码
COPY main/xiaozhi-server .

# 启动应用
CMD ["python", "app.py"]